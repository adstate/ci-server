# infra task

версия nodejs v10.14.1

билд-сервер лежит в папке server/
билд-агент лежит в папке agent/

Использовал typescript, так как начинал писать за несколько дней до лекции по типизации. Не все вышло 'красиво' в части типизации.
Думаю поправлю в рамках таска по типизации.

В задании нужно было поддрежать команду start, с TS не совсем понятно, что должно быть в старте.
Сделал такие команды для сервера:
    "start": "ts-node ./src/server.ts",
    "dev": "nodemon",
    "prod": "tsc && node ./build/server.js",

И для агента соотвественно:
    "start": "ts-node ./src/agent.ts",
    "dev": "nodemon",
    "prod": "tsc && node ./build/agent.js",

Для запуска сервера нужно указать в конфиге server-conf.json apiToken либо указать его в env файле как JWT_TOKEN.

В конфиге агента по-умолчанию прописан хост сервера 127.0.0.1, при запуске сервара на хосте отличном от агентов конфиш нужно поправить.


## Коротко по основным моментам:
### Сервер должен максимально утилизировать имеющихся агентов.
agentService сохраняет зарегистрированнх агентов в пулл. При каждой итерации проверки ожидающих билдов, выбиается первый свободный агент. После отправки на сборку, в случае если есть еще свободные агенты и ожидающие сборки билды - процесс интерации запускается без ожидания.

### Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать между сборками.
В основу взаимодействия сервера и агента положены нотификации по /notify-agent. Агент шлет нотификацию с равным интервалом на сервер, при первой нотификации сервер регистрирует агента. На сервере в agentService (не стал выносить в конфиг), установлен agentAliveTimeout. Если нотификация от агента не приходила больше чем agentAliveTimeout, то серверисключает агента из доступных и возвращает его билд, если он был, обратно в очередь.

Кажется, что если агент инициатор соединения, то он и должен периодически отправлять информацию о соединении на сервер.

### Сервер должен корректно обрабатывать ситуацию, когда агент прекратил работать в процессе выполнения сборки.
Описано в предыдущем пункте. Если агент будет недоступен больше чем agentAliveTimeout, то сервер билд в очередь и отпишет агента.
На случай быстрого перзапуска агента, можно добавить в /notify-agent buildId, чтобы сервер мог определять занят агент или нет, что позволило бы также востанавливать информацию о сборках на агентах после перезапуска сервера. Но вроде как явно это в требованиях не указывалось, и учитавая, ограничение времени, не стал это добавлять.

### Агент должен корректно обрабатывать ситуацию, когда при старте не смог соединиться с сервером.
Агент периодически шлет /notify-agent на сервер. Когда сервер будет доступен, агент зарегистрируется.

### Агент должен корректно обрабатывать ситуацию, когда при отправке результатов сборки не смог соединиться с сервером.
Если у агента не получается отправить результаты, то делается несколько повторов отправки. Если все повторы без успешны, результаты сборки удаляются. По истечении agentAliveTimeout сервер вернет несобранный билд в очередь.


Использовал докер образы для тестирования нескольких агентов. В актуализацию данных в контейнерах при измениях проекта не вникал.